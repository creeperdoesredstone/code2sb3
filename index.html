<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Code2SB3</title>

		<link rel="icon" type="image/x-icon" href="icon.png" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Cascadia+Code:ital,wght@0,200..700;1,200..700&family=Fira+Code:wght@300..700&family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="style.css" />
		<link rel="stylesheet" href="prism.css" />
		<link rel="stylesheet" href="blocks.css" />
	</head>
	<body>
		<nav>
			<button type="button" id="btn-settings" title="Settings">
				<i class="fa-solid fa-gear"></i>
			</button>
			<button
				type="button"
				id="btn-toggle-theme"
				title="Toggle theme"
				onclick="document.body.classList.toggle('light');
                const toggleBtn = document.querySelector('#btn-toggle-theme i');
                toggleBtn.classList.toggle('fa-sun');
                toggleBtn.classList.toggle('fa-moon');"
			>
				<i class="fa-solid fa-sun"></i>
			</button>
			<input
				type="text"
				id="inp-project-name"
				title="Project name"
				autocomplete="off"
				placeholder="New Project"
			/>
			<span>.sb3</span>
		</nav>
		<div class="container">
			<div class="actions">
				<button type="button" id="btn-files" title="Files">
					<i class="fa-solid fa-folder"></i>
				</button>
				<button
					type="button"
					id="btn-compile"
					class="btn-action"
					title="Compile"
				>
					<span>Compile</span>
				</button>
			</div>

			<div id="code-wrapper">
				<div contenteditable="plaintext-only" id="code"></div>
				<pre
					id="highlight-layer"
				><code id="highlight" class="language-php"></code></pre>
			</div>
		</div>
		<div class="container" id="workspace">
			<div id="workspace-top">
				<p>Preview</p>
				<button
					type="button"
					id="btn-export"
					class="btn-action"
					title="Export"
					disabled
				>
					<span>Export</span>
				</button>
			</div>

			<div id="blocks"></div>
		</div>

		<script src="scripts/prism.js"></script>
		<script async="false">
			const div = document.querySelector("#code");
			const highlightCode = document.querySelector("#highlight");
			const highlightLayer = document.querySelector("#highlight-layer");

			const removeTrailingBr = () => {
				let node = div.lastChild;
				while (
					node &&
					node.nodeType === Node.TEXT_NODE &&
					!node.textContent.trim()
				) {
					node = node.previousSibling;
				}

				if (node && node.nodeName === "BR") {
					div.removeChild(node);
				}
			};

			const updateHighlight = () => {
				let text = div.innerText;

				// Prism sometimes needs a trailing newline to render the last empty line correctly
				if (text.endsWith("\n")) {
					text += " ";
				}

				highlightCode.textContent = text;
				Prism.highlightElement(highlightCode);

				// Sync scroll
				highlightLayer.scrollTop = div.scrollTop;
				highlightLayer.scrollLeft = div.scrollLeft;
			};

			div.addEventListener("input", () => {
				removeTrailingBr();
				updateHighlight();
			});

			div.addEventListener("scroll", () => {
				highlightLayer.scrollTop = div.scrollTop;
				highlightLayer.scrollLeft = div.scrollLeft;
			});

			div.addEventListener("keydown", (event) => {
				if (event.key === "Tab") {
					event.preventDefault();
					const selection = window.getSelection();
					if (!selection.rangeCount) return;

					const range = selection.getRangeAt(0);
					const tabNode = document.createTextNode("\t");
					range.insertNode(tabNode);

					range.setStartAfter(tabNode);
					range.setEndAfter(tabNode);
					selection.removeAllRanges();
					selection.addRange(range);

					updateHighlight();
				}
			});

			removeTrailingBr();
		</script>

		<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
		<script src="scripts/main.js" type="module"></script>
		<script src="scripts/scratchExport.js"></script>
	</body>
</html>
